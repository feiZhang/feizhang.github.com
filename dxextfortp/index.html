<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Dxextfortp | 张非飞</title>
  <meta name="author" content="张飞">
  
  <meta name="description" content="技术,独立思考,梁鹏,张飞">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Dxextfortp"/>
  <meta property="og:site_name" content="张非飞"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="张非飞" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">张非飞</a></h1>
  <h2><a href="/">享受慢生活</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/archives">文章</a></li>
    
      <li><a href="/dxextfortp">DxExtForTP</a></li>
    
      <li><a href="/team">团队</a></li>
    
      <li><a href="/aboutme">AboutMe</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    

<li> <a title="把这个链接拖到你的Chrome收藏夹工具栏中" href='javascript:(function() {
    function c() {
        var e = document.createElement("link");
        e.setAttribute("type", "text/css");
        e.setAttribute("rel", "stylesheet");
        e.setAttribute("href", f);
        e.setAttribute("class", l);
        document.body.appendChild(e)
    }
 
    function h() {
        var e = document.getElementsByClassName(l);
        for (var t = 0; t < e.length; t++) {
            document.body.removeChild(e[t])
        }
    }
 
    function p() {
        var e = document.createElement("div");
        e.setAttribute("class", a);
        document.body.appendChild(e);
        setTimeout(function() {
            document.body.removeChild(e)
        }, 100)
    }
 
    function d(e) {
        return {
            height : e.offsetHeight,
            width : e.offsetWidth
        }
    }
 
    function v(i) {
        var s = d(i);
        return s.height > e && s.height < n && s.width > t && s.width < r
    }
 
    function m(e) {
        var t = e;
        var n = 0;
        while (!!t) {
            n += t.offsetTop;
            t = t.offsetParent
        }
        return n
    }
 
    function g() {
        var e = document.documentElement;
        if (!!window.innerWidth) {
            return window.innerHeight
        } else if (e && !isNaN(e.clientHeight)) {
            return e.clientHeight
        }
        return 0
    }
 
    function y() {
        if (window.pageYOffset) {
            return window.pageYOffset
        }
        return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
    }
 
    function E(e) {
        var t = m(e);
        return t >= w && t <= b + w
    }
 
    function S() {
        var e = document.createElement("audio");
        e.setAttribute("class", l);
        e.src = i;
        e.loop = false;
        e.addEventListener("canplay", function() {
            setTimeout(function() {
                x(k)
            }, 500);
            setTimeout(function() {
                N();
                p();
                for (var e = 0; e < O.length; e++) {
                    T(O[e])
                }
            }, 15500)
        }, true);
        e.addEventListener("ended", function() {
            N();
            h()
        }, true);
        e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
        document.body.appendChild(e);
        e.play()
    }
 
    function x(e) {
        e.className += " " + s + " " + o
    }
 
    function T(e) {
        e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
    }
 
    function N() {
        var e = document.getElementsByClassName(s);
        var t = new RegExp("\\b" + s + "\\b");
        for (var n = 0; n < e.length; ) {
            e[n].className = e[n].className.replace(t, "")
        }
    }
 
    var e = 30;
    var t = 30;
    var n = 350;
    var r = 350;
    var i = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";
    var s = "mw-harlem_shake_me";
    var o = "im_first";
    var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
    var a = "mw-strobe_light";
    var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
    var l = "mw_added_css";
    var b = g();
    var w = y();
    var C = document.getElementsByTagName("*");
    var k = null;
    for (var L = 0; L < C.length; L++) {
        var A = C[L];
        if (v(A)) {
            if (E(A)) {
                k = A;
                break
            }
        }
    }
    if (A === null) {
        console.warn("Could not find a node of the right size. Please try a different page.");
        return
    }
    c();
    S();
    var O = [];
    for (var L = 0; L < C.length; L++) {
        var A = C[L];
        if (v(A)) {
            O.push(A)
        }
    }
})()    '>High一下</a> </li>


  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="page">
  
  <div class="post-content">
    <header>
      
      
  
    <h1 class="title">Dxextfortp</h1>
  

    </header>
    <div class="entry">
      
        <h1><a href="https://github.com/feiZhang/DxExtForTP" target="_blank">DxExtForTP</a> 基础模块</h1>
<h2>功能介绍</h2>
<ol>
<li>快速构建 数据列表、新增、修改、查询 等数据操作基本功能</li>
<li>数据权限控制</li>
</ol>
<h2>总体说明</h2>
<p>系统扩展了TP的Model类、Action类，增加了一些基础功能，来完成一些通用的功能。</p>
<p>引入组件：</p>
<ol>
<li>sigma grid 数据列表，特色：自定义Grid头，分组显示数据，前端排序，列锁定</li>
<li>formvalidator 字段规则验证</li>
<li>min js和css合并压缩，后端完成</li>
<li>artDialog5 js对话框</li>
<li>bootstrap 全局风格</li>
<li>DatePicker 日期选择组件</li>
<li>jquery-upload-file 带进度条的文件上传</li>
<li>zTree 树</li>
<li>angularJs js框架（这个比较难懂一点，本系统的新增、修改功能使用了此框架，请先了解基本用法之后才进行代码修改）</li>
</ol>
<h2>使用</h2>
<ol>
<li>将组件复制到Web服务器，并将DxWebRoot配置到Web服务器某目录</li>
<li>TP项目的index.php文件增加 define(&#39;DXINFO_PATH‘,’/job/DxInfo&#39;)；配置目录所在的路径</li>
<li>拷贝doc目录下的config.php到项目应用的Conf目录下。</li>
<li>拷贝doc目录下的alias.php文件到项目应用的Conf目录下</li>
<li>拷贝doc目录下的 public 文件夹 到项目项目根目录</li>
<li>修改项目的config.php,修改 DX_PUBLIC 为DxWebRoot的Web路径</li>
<li>项目的Action继承DataOpeAction</li>
<li>项目的Model继承DxExtCommonModel</li>
</ol>
<h2>目录结构</h2>
<ol>
<li>doc 系统文档</li>
<li>DxTpl 公共的TP模板文件</li>
<li>DxBasicAction 供项目继承的公共功能，比如：账号管理、文件共享等等常用功能</li>
<li>DxWebRoot 公共的js和css文件。其中 basic 为模块所属的文件，min为js、css压缩组件，public为引入的第三方组件（<code>不允许修改public目录的任何文件，可采用功能覆盖的方式改写其行为</code>）</li>
<li>DxWidget 框架提供的Widget插件</li>
<li>Vendor 框架引入的第三方PHP组件</li>
<li>php文件，框架的基本文件，通过TP的 alias.php，别名自动引入，所以一般都以 .class.php 为扩展名</li>
</ol>
<h2>组件基本功能</h2>
<h3>TP auto功能扩展</h3>
<p>效果：将用户登录的Session值自动添加到某个字段，比如：create_userid</p>
<p>原理：</p>
<ol>
<li>在 DxExtCommonModel 的构造函数中，解析配置，将有效配置添加到TP的 _auto 中，如果Model有配置的字段，自动加到_auto中，如果没有则忽略</li>
<li><code>TP原来的auto只在create方法中执行，此框架将它复制到\_before_update 和 \_before_insert 中也执行</code></li>
</ol>
<p>例子：</p>
<pre><code><span class="attribute">'DP_POWER_FIELDS</span>' =&gt; <span class="keyword">array</span> (
    <span class="keyword">array</span> (
        <span class="attribute">'field_name</span>' =&gt; <span class="attribute">'create_userid</span>',
        <span class="attribute">'auto_type</span>' =&gt; <span class="number">1</span>,
        <span class="attribute">'type</span>' =&gt; <span class="number">0</span>,
        <span class="attribute">'session_field</span>' =&gt; <span class="string">"_id"</span> 
    )
)</code></pre>
<p>DP_POWER_FIELDS:TP的配置字段，数组形式，每个配置项作为数组的一个值</p>
<p>field_name：_auto要自动填充的数据库字段名</p>
<p>auto_type：TP的 _auto 类型，1:INSERT 2:UPDATE 3:BOTH，但是在配置文件中不能使用Model常量，所以只能用 1、2、3</p>
<p>type：DxExtCommonMode增加3个常量，3个类型都会增加到 _auto 中</p>
<ul>
<li>const DP_TYPE_ENABLE = 1;//数据权限控制字段，不仅增加到 _auto 中，同时作为 SELECT 注入的字段</li>
<li>const DP_TYPE_PUBLIC = 2;//数据权限控制，不仅增加到 _auto 中，同时作为 SELECT 注入的字段，数据的此字段等于1，则此数据所有人都可查看到，比如：全系统共享的公司手册</li>
<li>const DP_TYPE_STATIC_AUTO = 4;    //_auto的静态设定，自动填充，不使用Session值，而是用 auto_type 配置固定值，比如：同步状态要求，新增时全为1，更新时全为4</li>
</ul>
<p>session_field：填充字段的session下标，留空则使用 field_name 为下标</p>
<p>operator：对于自动填充无效，用户数据过滤时，确定过滤的方法，默认为“like”，可选“eq”</p>
<h3>数据权限控制</h3>
<p>效果：<br>1. 郑州市的员工只能查看郑州的数据，洛阳的员工只能查看洛阳的数据，河南省的员工能查看全省数据</p>
<p>原理：</p>
<ol>
<li>每个用户增加字段 canton_fdn，表示自己所处的区域</li>
<li>在每个需要数据权限控制的表中增加字段 canton_fdn（此值通过auto扩展，自动追加到每个用户添加的数据中，谁创建的数据，此数据属于创建人所在的区域）</li>
<li>查询数据时，自动注入本人的 canton_fdn 到查询语句中</li>
</ol>
<p>配置：</p>
<ol>
<li>超级人员不进行数据权限控制，设置其 Session[&quot;DP_ADMIN&quot;] = true</li>
<li>某些Module、Action不进行数据权限控制，&#39;DP_NOT_CHECK_ACTION&#39;    =&gt; array(“MODULE”=&gt;array(“Action”),“MODULE”=&gt;1);比如：Public、SyncData等Module，Module等于1，则此Module的全部Action都不进行数据权限控制</li>
</ol>
<p>例子：</p>
<ul>
<li>郑州的canton_fdn为：03520.01673.01674.</li>
<li>开封的canton_fdn为：03520.01673.01688.</li>
<li>河南省的canton_fdn为：03520.01673.</li>
<li>河南省员工创建的所有数据的canton_fdn为：03520.01673.</li>
<li>郑州员工创建的所有数据的canton_fdn为：03520.01673.01674.</li>
<li>…</li>
<li>自动注入的SQL条件为 canton_fdn LIKE &#39;查看人员的canton_fdn%&#39;</li>
</ul>
<h3>增删改查自动实现：listFields属性详解</h3>
<p>效果：通过配置Model，完成基本的增、删、改、查功能。</p>
<p>配置：</p>
<ol>
<li>Model 继承 DxExtCommonModel，即便是没有任何属性方法的Model，也需要继承。否则TP创建的Model实例来自于TP的Model。</li>
<li>配置Model的listFields属性、modelInfo属性</li>
<li>在Action中动态修改 listFields属性、modelInfo属性，实现界面显示的动态化，比如：根据用户的不同选择，显示或隐藏某个字段</li>
</ol>
<p>listFields属性详解：</p>
<ol>
<li>type:字段类型，string、int、float、t</li>
<li><p>date[日期]、enum[枚举,单选框]、select[枚举,下拉框]、set[集合]、uploadFile[文件上传]、canton[区域]、cutPhoto[剪切头像]</p>
<pre><code> type用于<span class="number">3</span>个地方：
 <span class="number">1.</span> grid生成时，sigma支持 string int float（排序结果不同）
 <span class="number">2.</span> 数据新增和修改时，生成不同的样式（input输入框、时间选择框、下拉选择框、单选框等）
 <span class="number">3.</span> 查询框中也可以使用这些属性生成

 uploadFile的附属参数:<span class="string">"upload"</span>=&gt;<span class="keyword">array</span>(<span class="string">"filetype"</span>=&gt;<span class="string">".gif、.jpeg、.jpg、.png、.pdf、.doc、.xls、.mp4、.mov"</span>,<span class="string">"maxNum"</span>=&gt;<span class="number">0</span>,<span class="string">"buttonValue"</span>=&gt;<span class="string">"文件上传"</span>,<span class="string">"maxSize"</span>=&gt;<span class="number">1024</span>*<span class="number">1024</span>)),
 uploadFile存储的数据不能直接显示，在model中配置 <span class="string">'data_change'</span>=&gt;<span class="keyword">array</span>(<span class="string">"file_name"</span>=&gt;<span class="string">"uploadFilesToGrid"</span>), 指定字段进行内容转义
 文件上传的路径，在config中配置：UPLOAD_BASE_PATH 和 TEMP_FILE_PATH
 set的附加参数:valFormat=json,douhao   分别表示，以json 或 逗号隔开 存储多选数据
 date的附加参数:valFormat=yyyy-MM-dd HH:mm:ss  就是js插件WdatePicker的参数格式
 canton的附加属性 canton=&gt;<span class="keyword">array</span>(<span class="string">"rootCantonId"</span>=&gt;<span class="number">3520</span>,<span class="string">"id_name"</span>=&gt;<span class="string">"canton_id"</span>)，即跟区域的Id，是否将选择的值赋值给id_name设定的input</code></pre>
</li>
<li>title:中文标题</li>
<li>hide:是否在前台生成此字段（此值使用位运算）。见常量 HIDE_FIELD_*，确定字段在某个场景下不生成html 或不处理。如果在多个位置不生成，等于各个值的和。比如：列表新增都不生成则为3</li>
<li>display_none:是否在界面上显示，hide控制是否在前端生成此html，display_none控制是否显示此html。有些字段，需要在新增、修改中存在，但是用户不可见</li>
<li>readOnly:字段数据为只读，其值类似于hide属性..一种情况：字典表的维护，添加时需要类型显示为不能改，但是又需要将类型值追加到数据中，则再model中重新定义save方法，如果是新增，则将type字段readOnly改为false,注：readOnly的字段，还是会从前端post过来，但是在后端会被忽略掉</li>
<li>pk:重定义主键字段。</li>
<li><p>width:输入框宽度，查询框的宽度<br>7.<br>textTo:将某个字典关联字段的id值对应的数据保存到某字段，比如：设置到org_id上的textTo=&quot;org_name&quot;,表示，存储org_id对应的机构名称到org_name，org_name为冗余字段，主要方便实现，通过机构名称 模糊查询,功能在dataope_ext中实现，绑定数据的change方法..org_name字段设置为隐藏字段</p>
<pre><code> 与字段的textTo对应的是modelInfo的textTo，在<span class="keyword">id</span>对应的数据改变时，更新关联的数据。</code></pre>
</li>
<li><p>valChange:数据转换，将表存储的key转换为对应的vaule，将userid转换显示为username，[固定转换\关联表转换\SQL语句转换]，比如：</p>
<pre><code>  <span class="string">"valChange"</span>=&gt;<span class="keyword">array</span>(<span class="string">"1"</span>=&gt;<span class="string">"客户"</span>,<span class="string">'4'</span>=&gt;<span class="string">'超级管理员'</span>)  将<span class="number">1</span>显示为客户，<span class="number">4</span>显示为超级管理员
  <span class="string">"valChange"</span>=&gt;<span class="keyword">array</span>(<span class="string">"model"</span>=&gt;<span class="string">"user"</span>,<span class="string">"type"</span>=&gt;<span class="string">"basic_data_type"</span>) 注意:这里对应的model必须设置modelInfo的dictTable值才有效，原理：从数据库获取数据（modelInfo的dictTable决定字段），生成和上面一样的数据格式，树状数据时启用type属性,使用逗号隔开，取多维数据的具体值
   <span class="string">"valChange"</span>=&gt;<span class="keyword">array</span>(<span class="string">"sql"</span>=&gt;<span class="string">"select xxx,yyy,zzz from user"</span>)，使用SQL语句替代上面的Model，增加灵活性                    </code></pre>
</li>
<li><p>total:数据总计的字符覆盖，某些字段不需要总机结构，比如：区域，则设置此值，替代统计行的显示，一般设为空，但必须设置，不设置则使用计算结构显示</p>
</li>
<li>danwei:数据框后面的数据单位说明，在列表界面也显示</li>
<li>note:数据新增修改时，字段后面的说明文字，比如：“固定电话请加区号”</li>
<li>frozen:是否锁定列（sigma相关）</li>
<li>grouped:字段是否进行分组合并显示（sigma相关）</li>
<li><p>renderer:数据转换，此处为js代码（sigma相关），比如：</p>
<pre><code>var valChange=<span class="function"><span class="keyword">function</span> <span class="title">valChangeCCCC</span><span class="params">(value ,record,columnObj,grid,colNo,rowNo)</span>{ <span class="title">var</span> <span class="title">valChange</span>=%<span class="title">s</span>;<span class="title">return</span> <span class="title">valChange</span><span class="params">[value]</span>;}</span></code></pre>
</li>
<li>field:字段实例，可以使用函数改变字段值，例如：DATE_FORMAT(subsidy_end_date,“%Y-%m”) subsidy_end_date        解决带函数字段问题。</li>
<li><p>editor:数据添加、修改时，自定义输入框。例子（实现selectselect功能）:</p>
<pre><code> "editor"=&gt;"<span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">'selectCanton'</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>                                                                             <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">'hidden'</span> <span class="attribute">id</span>=<span class="value">'canton_fdn'</span> <span class="attribute">name</span>=<span class="value">'canton_fdn'</span> <span class="attribute">value</span>=<span class="value">''</span> /&gt;</span>                                          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">'hidden'</span> <span class="attribute">id</span>=<span class="value">'canton_id'</span> <span class="attribute">name</span>=<span class="value">'canton_id'</span> <span class="attribute">value</span>=<span class="value">''</span> /&gt;</span>
             <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">'text/javascript'</span>&gt;</span><span class="javascript">
             (<span class="keyword">function</span>($){
                 $.selectselectselect(<span class="number">0</span>,<span class="string">'selectCanton'</span>,<span class="number">0</span>,ROOT_CANTON_ID,<span class="keyword">function</span>(t){
                 $(<span class="string">'#canton_id'</span>).val($(t).find(<span class="string">'option:selected'</span>).attr(<span class="string">'key'</span>));
                 $(<span class="string">'#canton_fdn'</span>).val($(t).val());
                 });
             })(jQuery);
             </span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
             ",</code></pre>
</li>
<li>default:默认值(String|Array)<pre><code>字符串:直接做为默认值. 为防止数据出现混乱,默认值在readonly及编辑时不生效.
数组:最少两个元素,第一个元素表示值的类型,为func时,第二个值为函数名,之后的数据为函数的参数.如<span class="keyword">array</span>(<span class="attribute">'func</span>', <span class="attribute">'test</span>', <span class="attribute">'p1</span>', <span class="attribute">'p2</span>'),则调用test(<span class="attribute">'p1</span>', <span class="attribute">'p2</span>');</code></pre>
</li>
</ol>
<p>例子：参考Demo程序</p>
<h3>导出为Excel</h3>
<p>listFields的hide属性，来确定导出字段</p>
<h3>数据打印</h3>
<p>listFields的hide属性，来确定打印字段，使用了打印组件：<a href="&quot;http://mtsoftware.v053.gokao.net/download.html&quot;">Lodop</a></p>
<h3>modelInfo属性详解</h3>
<ol>
<li>title:中文说明</li>
<li>addTitle:新增按钮的中文说明,默认为：新增+title内容</li>
<li>editTitle:修改的中文说明，默认为：修改+title内容</li>
<li>readOnly:本Model是否不需要新增数据</li>
<li>otherManageAction:本model除新增外的其他操作</li>
<li><p>searchHTML:操作框的html信息，一般为搜索框和查询按钮，搜索框支持的特性：</p>
<pre><code> <span class="number">1.</span>name对应model数据字段 
 <span class="number">2.</span>class=<span class="string">"dataOpeSearch"</span>表示是查询条件
 <span class="number">3.</span>class=<span class="string">"likeLeft likeRight"</span>表示模糊查询的左相似或右相似,name增加前缀 gt_  egt_  lt_  elt_ 支持符号操作，一般应用于时间
 <span class="number">4.</span>支持radio类型input
 <span class="number">5.</span>查询按钮执行js函数触发查询 dataOpeSearch(是否使用条件)
 <span class="number">6.</span>暂时不再支持使用 createFieldInput 方法，生成查询输入框（两个Canton会互相影响）
 例子(使用bootstrap样式):
     <span class="xml"><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"add-on"</span>&gt;</span>老人姓名:<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch z_input likeRight likeLeft"</span> <span class="attribute">name</span>=<span class="value">"name"</span> <span class="attribute">id</span>=<span class="value">"name"</span> <span class="attribute">value</span>=<span class="value">""</span> <span class="attribute">style</span>=<span class="value">"width:60px;"</span>/&gt;</span>
     <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"add-on"</span>&gt;</span>
     审核:
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"radio"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch"</span> <span class="attribute">name</span>=<span class="value">"check_state"</span> <span class="attribute">id</span>=<span class="value">"check_state"</span> <span class="attribute">value</span>=<span class="value">"1"</span>/&gt;</span>通过
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"radio"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch"</span> <span class="attribute">name</span>=<span class="value">"check_state"</span> <span class="attribute">id</span>=<span class="value">"check_state"</span> <span class="attribute">value</span>=<span class="value">"2"</span>/&gt;</span>异常
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"radio"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch"</span> <span class="attribute">name</span>=<span class="value">"check_state"</span> <span class="attribute">id</span>=<span class="value">"check_state"</span> <span class="attribute">value</span>=<span class="value">""</span> <span class="attribute">checked</span>/&gt;</span>不限
     <span class="tag">&lt;/<span class="title">span</span>&gt;</span>
     <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"add-on"</span>&gt;</span>
     年龄从：
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch"</span> <span class="attribute">id</span>=<span class="value">"egt_age"</span> <span class="attribute">name</span>=<span class="value">"egt_age"</span> <span class="attribute">value</span>=<span class="value">""</span>&gt;</span>到
     <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">class</span>=<span class="value">"dataOpeSearch"</span> <span class="attribute">id</span>=<span class="value">"elt_age"</span> <span class="attribute">name</span>=<span class="value">"elt_age"</span> <span class="attribute">value</span>=<span class="value">""</span>&gt;</span>
     <span class="tag">&lt;/<span class="title">span</span>&gt;</span>
     <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"btn"</span> <span class="attribute">onclick</span>=<span class="value">\'javascript:dataOpeSearch(true);\'</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">id</span>=<span class="value">"allLaoren"</span>&gt;</span>查询<span class="tag">&lt;/<span class="title">button</span>&gt;</span>
     <span class="tag">&lt;<span class="title">button</span> <span class="attribute">onclick</span>=<span class="value">"javascript:dataOpeSearch(false);"</span> <span class="attribute">class</span>=<span class="value">"btn"</span> <span class="attribute">id</span>=<span class="value">"item_query_all"</span>&gt;</span>全部数据<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span></code></pre>
</li>
<li><p>dictTable:字典表值字段,格式1. dictTable=“title”（生成以主键为key，值字段数据为值的 数组) 格式2:dictTable=“keyField,keyField,..,valueField”);(其中keyField是作为数据关联的字段)   根据这个配置，程序自动将字典表转换为valChange的普通模式，这些数组会被缓存到Runtime得Data目录</p>
</li>
<li>dictType:字典表的类型，可以是 “mySelf” 和 公共(默认)。公共的字典缓存是大家共享的，比如：老人类型，私有的缓存是各自单独存放，比如:职工信息,每个养老院添加老人选择护理员时，只选自己的职工</li>
<li>toString:提供给toString方法，整合数据的个是，   toString=array(“%s %s 生于%s”,array(&quot;real_name“,”sex“,”birthday&quot;))</li>
<li>helpInfo:帮助提示信息，sigma grid底部</li>
<li>data_change:数据在后台就进行数据字典转换，尽量少用，valChange是将数据转换的工作交给js，减少后台php的执行时间，但是某些特殊转换无法使用valChange完成，则可以使用data_change，在后台获取到数据后，调用函数对数据进行转换，这样会耗费大量的php执行，离子：补贴状态转换 &#39;data_change&#39;=&gt;array(&quot;aysn_state“=&gt;”subsidyStateChange&quot;),</li>
<li>enablePage:grid是否提供分页。（sigma相关）</li>
<li>enablePrint:grid是否提供打印</li>
<li>enableExport:grid是否提供导出excel功能</li>
<li>enableImport:grid是否提供导入功能，一般为Excel</li>
<li>gridHeader:自定义报表的个性化表头，不要写table标签，只写TR标签即可。系统会自动追加Table标签。（sigma相关）</li>
<li>order:默认的数据排序（sigma相关）</li>
<li>stripeRows:grid是否交替颜色</li>
<li>showTotal:是否在数据最后一行增加总计列。此列由上面列出的数据，计算总数获得。</li>
<li>hasCheckBox:数据列表是否有checkbox（sigma相关）</li>
<li><p>customRowAttribute:grid自定义样式，例如：</p>
<pre><code>'customRowAttribute' =&gt; "function(record,rowNo,grid)<span class="special">{</span>if(last_show_worker_id!=record.worker_id)<span class="special">{</span>last_show_worker_id=record.worker_id;<span class="special">}</span>else<span class="special">{</span>return 'style=<span class="command">\\</span><span class="command">\"</span>background-color:<span class="special">#</span>cccccc<span class="command">\\</span><span class="command">\"</span>';<span class="special">}</span><span class="special">}</span>",</code></pre>
</li>
<li>total:是否在数据最后一行，增加总计行</li>
<li>leftArea:左边增加的内容，比如：左边可以加一个区域树等，此变量为html代码</li>
<li>enableImport:允许导入数据</li>
<li>addPageColumnNum:新增、修改页面的列数，默认为1.</li>
<li>textTo：格式 array(“modelName”=&gt;array(“fromid”=&gt;“”,“toid”=&gt;“”,“fromtextto”=&gt;“”,“textto”=&gt;“”))，modelName是关联的Model名称，例如：EmployeeModel的textTo设置为：array(“ServiceList”=&gt;array(“fromid”=&gt;&quot;pk_id“,”toid“=&gt;”employee_id“,”fromtextto“=&gt;”name“,”textto“=&gt;”employee_name&quot;))，其中pk_id、name是employee表的字段，employee_id、employee_name是service_list的字段；功能在model的 _after_update 和 _before_delete 中实现。</li>
<li>relationDelete：关联删除，删除一个数据后，同时删除其附属的数据，比如：删除老人后，同时删除老人所属的各种服务组。格式 array(“modelName”=&gt;array(“fromid”=&gt;“”,“toid”=&gt;“”)) 参考 textTo的定义</li>
</ol>
<h3>全文索引</h3>
<p>效果：通过一个查询框，能够查询多个Model的主要属性，比如：机构名称、老人名称、员工名称等。类似google的效果。</p>
<ol>
<li>配置各个Model的toString，则此Model将进入全文索引支持</li>
<li>在需要查询所有的地方，直接查询Model：FulltextSearch，表结构为：fulltext_search(object,pkid,content,object_title)</li>
<li>全局配置变量  FULLTEXT_SEARCH  来开启全文索引功能</li>
<li>在Model的_before_insert  _before_update中设置model的变量fullTextState，从而设定此数据是否为消息数据（消息就是系统的主要业务数据，一般显示在首页，比如:待办事项,请假等，有后续需要处理的数据）</li>
</ol>
<p>原理：在Model的insert update delete方法中，更新全文检索表数据。</p>
<h3>标记删除</h3>
<p>效果：将数据做删除标记，而不进行物理删除，但前台依然无法查看此数据</p>
<p>配置：DELETE_TAGS =&gt; array(“field”=&gt;value,“field���=&gt;value)，field为删除标记的字段名，value为标记为删除的值。注意：任何一个字段标记为删除值，就表示已删除（同步删除标记 和 系统删除标记 共存的需要）</p>
<h3>TP的数据验证规则自动转换为Js验证</h3>
<p>效果：后台书写TP的数据验证规则，前台js自动有此验证规则。</p>
<p>组件：<a href="http://www.position-relative.net/creation/formValidator/" target="_blank">http://www.position-relative.net/creation/formValidator/</a></p>
<pre><code>注意：
前端验证的提示信息，是在js中指定的。来自于框架的定义，无法变动。。比如：唯一性，统计是：* 此处不可为空<span class="comment">;</span>
框架不支持，对每个input指定，不同的必填说明。
所以，后台验证规则的错误描述语言应尽量与前台保持一致。参考：jquery<span class="preprocessor">.validationEngine</span>-zh_CN<span class="preprocessor">.js</span></code></pre>
<h3>操作日志</h3>
<p>效果：系统自动记录操作日志到表operation_log中，表格式固定</p>
<h3>数据变更日志</h3>
<p>效果:数据变动日志，系统自动记录数据变动日志到表DataChangeLog中，表格式固定，目前问题：时间不长，表就较大了。</p>
<h3>自定义Action的Model</h3>
<ol>
<li>支持表关联，通过设置Model的变量：protected $viewTableName =&#39;(SELECT e.*,eg.name group_name FROM employee e LEFT JOIN employee_group_member egm ON egm.employee_id=e.employee_id LEFT JOIN employee_group eg ON eg.employee_group_id=egm.employee_group_id) emp&#39;; 来支持多表连结，不用创建视图，写多个Model了。</li>
<li>Action使用非同名Model，通过设置Action的变量：theModelName，来指定此Action使用的Model</li>
</ol>
<h3>自定义模板布局</h3>
<p>比如：重新排列新增页面的组件等。</p>
<p>自定义布局使用了TP的模板继承功能，</p>
<p>在自定义的模板文件中，引入如下代码（如果重写了Action的方法，必须设置 dx_data_edit 的值）</p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">extend</span> <span class="attribute">name</span>=<span class="value">"</span><span class="variable">$dx_data_edit</span><span class="xml">" /&gt;
<span class="tag">&lt;<span class="title">block</span> <span class="attribute">name</span>=<span class="value">"dataEditFormTable"</span>&gt;</span>
    自定义模板内容，一般为一个table标签，及数据字段
    <span class="pi">&lt;?php echo DxFunction::createFieldInput(</span><span class="variable">$listFields</span><span class="xml">["name"]);?&gt;
<span class="tag">&lt;/<span class="title">block</span>&gt;</span></span></code></pre>
<h3>数据过滤</h3>
<p>通过URL传递过滤项，比如：SysDic的实现，通过在URL（SysDic/index/type/SubsidyRank/modelTitle/补贴类型）增加type（过滤数据） modelTitle（改变页面标题：SysDic对应的标题应该是数据字典），可以将一个Model分隔为不同的功能：员工类型管理、房间类型管理等。</p>
<p>系统支持，终身过滤（默认,grid的数据一直收到此参数的影响），临时过滤（url增加此参数ignoreInitSearch=1）</p>
<h3>关闭特定 Module 的 Dx 框架模版缓存</h3>
<p>见dxDisplay方法代码，调用module的 setDxTplCacheDisable() 方法，仅用DxExtForTP的二次编译缓存。大多数情况下，可以通过修改代码避免此操作，特定条件下可使用。在执行dxDisplay前执行。</p>
<h2>其他功能扩展</h2>
<p>原理：在组件中实现基础的功能Action和Model，让项目去继承使用，比如：角色管理、用户管理、登录等。</p>
<h2>消息提示</h2>
<p>在Action中使用 $this-&gt;success(“消息内容”,“showmsg”);会出现提示信息，并不跳转页面。注意：如果需要结束执行代码，则在此语句随后增加 exit; 语句</p>
<p>*die显示的内容，会因为编码问题，在浏览器上显示为乱码</p>
<h2>全局数据缓存</h2>
<p>DxModel方法cacheData(false)对此表进行全局数据缓存，通过Think.config.modelName.key获取数据.(目前仅缓存SysSetting表，使用name，val字段作为key和数据,若需扩展功能，可借鉴DictCache的方法)</p>
<h2>对话框显示数据列表</h2>
<p>增加了js函数：dataOpeListDialog，［居家业务的客户购买服务对话框使用到下面的所有参数］其参数config的值定义</p>
<ol>
<li>title：对话框的标题</li>
<li>ok：对话框点击ok按钮时执行的方法（一般通过jQuery解析对话框内容，ajax提交到服务器）</li>
<li>html：对话框显示html的附加内容（除数据列表外的其他业务所需的数据值）</li>
<li>moduleName：显示那个Module的数据列表（注意不是model）</li>
<li>dataUrl：显示列表的数据来源Url（数据格式为grid默认格式）</li>
<li>excludeHeight：显示数据列表的高度</li>
<li>onComplete：数据列表的grid数据加载完成后要执行的函数，（参数为grid本身，比如：将grid的checkbox选中，就需要此函数协助）</li>
</ol>
<h2>常见问题</h2>
<ol>
<li>Model:getCacheDictTableData您所请求的方法不存在！ 原因：1.没有定义字典表的Model 2.使用的model中的“valChange”=&gt;array(“model”=&gt;“Role”)中的model要使用大写，例如Role，不能写作role。</li>
<li>ModeI变量listFields的改变，必须在构造函数中, 使用setListField、addListField完成。因为系统会缓存ListFieIds数据</li>
</ol>
<h2>注意事项</h2>
<ol>
<li>除非框架本身无法支持的功能，请勿随意在项目中重写 add.html data_edit.html data_list.html 各种父类的方法（DxExtCommonAction、DxExtCommonModel）</li>
<li>需要增加功能时，请使用类继承的方式，重写Action或Model的方法，请勿随意改动框架代码（框架代码仅支持公共功能）</li>
<li>模块级别的模板，使用新增的dxDisplay方法输出内容（增加了二次编译的支持，第一次编译：将组件模板编译为普通模板(生成字段列表等) 第二次编译：将系统数据引入模板）</li>
<li>由于TP项目的混乱，在LocationTemplateBehavior中有判断模板文件的函数，在 ThinkTemplate 中也有类似的函数，并且TP对tags的支持也有些混乱 (在view中调用了tags来处理模板文件，但是在处理include和模板继承中，又没有调用)，所以对于重写判定 模板文件的方法，就有些困难，目前框架支持TP3.1.2，如果要升级ThinkPHP请注意此问题。（框架在DxParseTemplateBehavior中增加了判断模板文件的函数，在TemplateDx中增加了对于include的处理，支持DxPublic和模板文件搜索）</li>
<li>在save方法中调用insertOrUpdate方法时，如果是修改操作，会自动将设置readOnly的Post数据unset掉，所以，如果需要在后续继续操作此数据，则请先保存数据到变量中，随后恢复之</li>
<li>升级TP的版本，1.测试系统功能 2.DxModel的方法 myAutoOperation 代码更新</li>
</ol>
<h2>版本历程</h2>
<ol>
<li>0.1版:为了实现简单代码重用和客户自定义界面，构建了FormAuto</li>
<li>0.2版:将功能限定为简单代码重用，构建DxExtForTP雏形</li>
<li>0.3版:将分散的各个模块文件集中在一个独立的项目中，与实际项目隔离（1.对模块实现源码控制 2.简单的项目引用 3.简单的代码升级）</li>
<li>0.4版:引入angularJs，增加modelInfo的textTo，relation_delete属性</li>
</ol>

      
    </div>
    <footer>
      
        
        

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_tools_1"></a>
    <a class="jiathis_button_tools_2"></a>
    <a class="jiathis_button_tools_3"></a>
    <a class="jiathis_button_tools_4"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

<!-- Duoshuo Comment BEGIN -->
    <div class="ds-thread"></div>
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"liangpeng"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
<!-- Duoshuo Comment END -->

</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:www.liangpeng.net">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/y2013/m11/project-design-and-code-organization-case-study.html">项目设计与代码组织-案例分析</a>
      </li>
    
      <li>
        <a href="/y2013/m11/fight-for-their-own-interests-new-employees-series.html">为自己的利益而奋斗－新员工系列</a>
      </li>
    
      <li>
        <a href="/y2013/m09/write-a-meaningful-requirements-document.html">写出一份有意义的需求文档</a>
      </li>
    
      <li>
        <a href="/y2013/m08/javascript-run-in-ajax.html">谨慎使用ajax动态引入js(附代码与结果)</a>
      </li>
    
      <li>
        <a href="/y2013/m08/i-have-in-mind-the-companys-products-should-be-so.html">好的产品应该是这样的</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/.NET/" style="font-size: 10.00px;">.NET</a><a href="/tags/30岁/" style="font-size: 10.00px;">30岁</a><a href="/tags/404/" style="font-size: 10.00px;">404</a><a href="/tags/4G/" style="font-size: 10.00px;">4G</a><a href="/tags/80后/" style="font-size: 10.00px;">80后</a><a href="/tags/90后/" style="font-size: 10.00px;">90后</a><a href="/tags/9城/" style="font-size: 10.00px;">9城</a><a href="/tags/B股/" style="font-size: 10.00px;">B股</a><a href="/tags/CPI/" style="font-size: 10.00px;">CPI</a><a href="/tags/DBA/" style="font-size: 10.00px;">DBA</a><a href="/tags/ET128/" style="font-size: 10.00px;">ET128</a><a href="/tags/Eclipse/" style="font-size: 10.00px;">Eclipse</a><a href="/tags/GB2312/" style="font-size: 10.00px;">GB2312</a><a href="/tags/GBK/" style="font-size: 10.00px;">GBK</a><a href="/tags/QQ崩溃/" style="font-size: 10.00px;">QQ崩溃</a><a href="/tags/SQL SERVER/" style="font-size: 10.00px;">SQL SERVER</a><a href="/tags/UML/" style="font-size: 10.00px;">UML</a><a href="/tags/UTF-8/" style="font-size: 10.00px;">UTF-8</a><a href="/tags/WOW/" style="font-size: 20.00px;">WOW</a><a href="/tags/a200/" style="font-size: 10.00px;">a200</a><a href="/tags/ajax/" style="font-size: 10.00px;">ajax</a><a href="/tags/android/" style="font-size: 10.00px;">android</a><a href="/tags/apple/" style="font-size: 15.00px;">apple</a><a href="/tags/apt-get/" style="font-size: 10.00px;">apt-get</a><a href="/tags/asterisk/" style="font-size: 10.00px;">asterisk</a><a href="/tags/atom协议/" style="font-size: 10.00px;">atom协议</a><a href="/tags/awesome/" style="font-size: 10.00px;">awesome</a><a href="/tags/bug/" style="font-size: 10.00px;">bug</a><a href="/tags/chrome/" style="font-size: 10.00px;">chrome</a><a href="/tags/cookie/" style="font-size: 10.00px;">cookie</a><a href="/tags/css/" style="font-size: 15.00px;">css</a><a href="/tags/darggable/" style="font-size: 10.00px;">darggable</a><a href="/tags/dialog/" style="font-size: 10.00px;">dialog</a><a href="/tags/div/" style="font-size: 15.00px;">div</a><a href="/tags/dns/" style="font-size: 10.00px;">dns</a><a href="/tags/drupal/" style="font-size: 10.00px;">drupal</a><a href="/tags/editdns/" style="font-size: 10.00px;">editdns</a><a href="/tags/everydns/" style="font-size: 10.00px;">everydns</a><a href="/tags/firefox/" style="font-size: 20.00px;">firefox</a><a href="/tags/flash上传/" style="font-size: 10.00px;">flash上传</a>
  </div>
</div>


  

  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://gtd.im" title="GTD 社区">GTD.im</a></li>
</ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 张飞
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>